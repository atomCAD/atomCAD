# UFF Energy Minimization: Geometry Validation Against RDKit

**Date:** 2026-02-16

## Background

atomCAD includes a native Rust implementation of the Universal Force Field (UFF), the widely-used molecular mechanics force field published by Rappe et al. (1992). Our implementation covers all bonded energy terms (bond stretching, angle bending, torsion, inversion) as well as van der Waals nonbonded interactions (Lennard-Jones 12-6). The force field drives an L-BFGS geometry optimizer that relaxes molecular structures to their energy minimum.

Since we ported the UFF implementation from RDKit's well-established C++ code, we needed a rigorous way to validate that our Rust port produces correct results. Individual energy term tests are necessary but not sufficient -- the ultimate question is: **does our optimizer find the same minimum-energy geometry as RDKit?**

## Methodology

We generated reference data by running RDKit's UFF optimizer on a test suite of 9 molecules spanning different chemistries:

| Molecule | Atoms | Bonds | vdW pairs | Chemistry |
|---|---|---|---|---|
| Methane | 5 | 4 | 0 | Tetrahedral sp3 |
| Ethylene | 6 | 5 | 3 | Planar sp2, double bond |
| Ethane | 8 | 7 | 9 | Two tetrahedral carbons |
| Benzene | 12 | 12 | 36 | Aromatic ring |
| Butane | 14 | 13 | 55 | Flexible chain, torsion |
| Water | 3 | 2 | 0 | Bent, lone pairs |
| Ammonia | 4 | 3 | 0 | Pyramidal, C3v symmetry |
| Adamantane | 26 | 28 | 237 | Cage hydrocarbon |
| Methanethiol | 6 | 5 | 3 | Sulfur heteroatom |

Both optimizers start from the same initial geometry (RDKit's `EmbedMolecule` with seed 42) and minimize using the full UFF energy surface including van der Waals terms.

Comparing minimized geometries is not as simple as comparing atom coordinates directly, because a minimized molecule can be freely translated and rotated in space without changing its energy. Two optimizers will generally find the same shape but in different orientations. We solve this using **Kabsch superposition** (Kabsch, 1976): an SVD-based algorithm that finds the optimal rigid-body alignment (translation + rotation) between two point sets, then computes the root-mean-square deviation (RMSD) of the aligned coordinates.

## Results

| Molecule | RMSD (angstrom) | Max atomic deviation (angstrom) |
|---|---|---|
| Methane | 0.000000 | 0.000000 |
| Ethylene | 0.000000 | 0.000000 |
| Ethane | 0.000001 | 0.000001 |
| Benzene | 0.000001 | 0.000002 |
| Butane | 0.000007 | 0.000012 |
| Water | 0.000001 | 0.000001 |
| Ammonia | 0.000000 | 0.000000 |
| Adamantane | 0.000003 | 0.000006 |
| Methanethiol | 0.000001 | 0.000002 |

The worst-case RMSD is **0.000007 angstrom** (butane, 7 femtometers). The worst-case single-atom deviation is **0.000012 angstrom** (12 femtometers). For context, a carbon-carbon bond is ~1.5 angstrom, so these deviations are roughly **8 orders of magnitude** smaller than a bond length.

## Interpretation

Our Rust UFF implementation produces minimized geometries that are numerically identical to RDKit's to within floating-point precision. This validates:

- **All bonded energy terms** (stretch, bend, torsion, inversion) and their analytical gradients
- **Van der Waals interactions** (Lennard-Jones 12-6) and their gradients
- **The L-BFGS optimizer** converges to the same minimum as RDKit's implementation
- **Topology detection** (bond/angle/torsion/inversion enumeration, nonbonded pair exclusions) matches RDKit

The fact that even adamantane (26 atoms, 237 van der Waals pairs, 28 bonds, 60 angles) matches to femtometer precision gives high confidence that the implementation is correct, not just approximately right.

## Test location

The Kabsch RMSD test is implemented in:

```
rust/tests/crystolecule/simulation/minimize_test.rs
    -> b11_all_molecules_rmsd_vs_reference()
```

Reference data generated by RDKit is stored in:

```
rust/tests/crystolecule/simulation/test_data/uff_reference.json
```

## References

- Rappe, A. K. et al. "UFF, a full periodic table force field for molecular mechanics and molecular dynamics simulations." *J. Am. Chem. Soc.* 114, 10024-10035 (1992).
- Kabsch, W. "A solution for the best rotation to relate two sets of vectors." *Acta Crystallographica* A32, 922-923 (1976).
- RDKit: Open-source cheminformatics. https://www.rdkit.org/
